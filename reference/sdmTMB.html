<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Fit a spatial or spatiotemporal GLMM with TMB — sdmTMB • sdmTMB</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Fit a spatial or spatiotemporal GLMM with TMB — sdmTMB" />
<meta property="og:description" content="Fit a spatial or spatiotemporal predictive-process GLMM with TMB.
Among other uses, this can be useful for (dynamic) species distribution
models and relative abundance index standardization." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sdmTMB</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.12.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/index-standardization.html">Index standardization with sdmTMB</a>
    </li>
    <li>
      <a href="../articles/model-description.html">Model description</a>
    </li>
    <li>
      <a href="../articles/spatial-trend-models.html">Fitting spatial trend models with sdmTMB</a>
    </li>
    <li>
      <a href="../articles/threshold-models.html">Threshold modeling with sdmTMB</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/seananderson/sdmTMB/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Fit a spatial or spatiotemporal GLMM with TMB</h1>
    <small class="dont-index">Source: <a href='https://github.com/seananderson/sdmTMB/blob/master/R/fit.R'><code>R/fit.R</code></a></small>
    <div class="hidden name"><code>sdmTMB.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Fit a spatial or spatiotemporal predictive-process GLMM with TMB.
Among other uses, this can be useful for (dynamic) species distribution
models and relative abundance index standardization.</p>
    </div>

    <pre class="usage"><span class='fu'>sdmTMB</span><span class='op'>(</span>
  <span class='va'>formula</span>,
  <span class='va'>data</span>,
  <span class='va'>spde</span>,
  time <span class='op'>=</span> <span class='cn'>NULL</span>,
  family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>gaussian</a></span><span class='op'>(</span>link <span class='op'>=</span> <span class='st'>"identity"</span><span class='op'>)</span>,
  time_varying <span class='op'>=</span> <span class='cn'>NULL</span>,
  weights <span class='op'>=</span> <span class='cn'>NULL</span>,
  extra_time <span class='op'>=</span> <span class='cn'>NULL</span>,
  reml <span class='op'>=</span> <span class='cn'>FALSE</span>,
  silent <span class='op'>=</span> <span class='cn'>TRUE</span>,
  multiphase <span class='op'>=</span> <span class='cn'>TRUE</span>,
  anisotropy <span class='op'>=</span> <span class='cn'>FALSE</span>,
  control <span class='op'>=</span> <span class='fu'><a href='sdmTMBcontrol.html'>sdmTMBcontrol</a></span><span class='op'>(</span><span class='op'>)</span>,
  penalties <span class='op'>=</span> <span class='cn'>NULL</span>,
  ar1_fields <span class='op'>=</span> <span class='cn'>FALSE</span>,
  include_spatial <span class='op'>=</span> <span class='cn'>TRUE</span>,
  spatial_trend <span class='op'>=</span> <span class='cn'>FALSE</span>,
  spatial_only <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/identical.html'>identical</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>data</span><span class='op'>[[</span><span class='va'>time</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span>, <span class='fl'>1L</span><span class='op'>)</span>,
  nlminb_loops <span class='op'>=</span> <span class='fl'>1</span>,
  newton_steps <span class='op'>=</span> <span class='fl'>0</span>,
  mgcv <span class='op'>=</span> <span class='cn'>TRUE</span>,
  previous_fit <span class='op'>=</span> <span class='cn'>NULL</span>,
  quadratic_roots <span class='op'>=</span> <span class='cn'>FALSE</span>,
  epsilon_predictor <span class='op'>=</span> <span class='cn'>NULL</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>formula</th>
      <td><p>Model formula. See the Details section below for how to specify
offsets and threshold parameters. For index standardization, you may wish
to include <code>0 + as.factor(year)</code> (or whatever the time column is called)
in the formula. IID random intercepts are possible using <span class="pkg">lme4</span>
syntax, e.g., <code>+ (1 | g)</code> where <code>g</code> is a column with factor levels.
Splines are possible via mgcv. See examples below.</p></td>
    </tr>
    <tr>
      <th>data</th>
      <td><p>A data frame.</p></td>
    </tr>
    <tr>
      <th>spde</th>
      <td><p>An object from <code><a href='make_mesh.html'>make_mesh()</a></code>.</p></td>
    </tr>
    <tr>
      <th>time</th>
      <td><p>The time column (as character). Leave as <code>NULL</code> for a spatial-only
model.</p></td>
    </tr>
    <tr>
      <th>family</th>
      <td><p>The family and link. Supports <code><a href='https://rdrr.io/r/stats/family.html'>gaussian()</a></code>, <code><a href='https://rdrr.io/r/stats/family.html'>Gamma()</a></code>,
<code><a href='https://rdrr.io/r/stats/family.html'>binomial()</a></code>, <code><a href='https://rdrr.io/r/stats/family.html'>poisson()</a></code>, <code><a href='Families.html'>Beta()</a></code>,
<code><a href='Families.html'>nbinom2()</a></code>, and
<code><a href='Families.html'>tweedie()</a></code>]. For binomial family options,
see the 'Binomial families' section below.</p></td>
    </tr>
    <tr>
      <th>time_varying</th>
      <td><p>An optional formula describing covariates that should be
modelled as a random walk through time. Be careul not to include
covariates (including the intercept) in both the main and time-varying
formula. I.e., at least one should have <code>~ 0</code> or ~ -1`.</p></td>
    </tr>
    <tr>
      <th>weights</th>
      <td><p>Optional likelihood weights for the conditional model.
Implemented as in <span class="pkg">glmmTMB</span>. In other words, weights do not have to sum
to one and are not internally modified. Can also be used for trials with
the binomial family. See Details below.</p></td>
    </tr>
    <tr>
      <th>extra_time</th>
      <td><p>Optional extra time slices (e.g., years) to include for
interpolation or forecasting with the predict function. See the
Details section below.</p></td>
    </tr>
    <tr>
      <th>reml</th>
      <td><p>Logical: use REML (restricted maximum likelihood) estimation
rather than maximum likelihood? Internally, this adds the fixed effects
to the list of random effects to intetgrate over.</p></td>
    </tr>
    <tr>
      <th>silent</th>
      <td><p>Silent or include optimization details?</p></td>
    </tr>
    <tr>
      <th>multiphase</th>
      <td><p>Logical: estimate the fixed and random effects in phases?
Phases are usually faster and more stable.</p></td>
    </tr>
    <tr>
      <th>anisotropy</th>
      <td><p>Logical: allow for anisotropy? See <code><a href='plot_anisotropy.html'>plot_anisotropy()</a></code>.</p></td>
    </tr>
    <tr>
      <th>control</th>
      <td><p>Optimization control options. See <code><a href='sdmTMBcontrol.html'>sdmTMBcontrol()</a></code>.</p></td>
    </tr>
    <tr>
      <th>penalties</th>
      <td><p>Optional vector of penalties (priors) on the fixed effects.
See the Regularization Details section below.
below.</p></td>
    </tr>
    <tr>
      <th>ar1_fields</th>
      <td><p>Estimate the spatiotemporal random fields as a
stationary AR1 process?</p></td>
    </tr>
    <tr>
      <th>include_spatial</th>
      <td><p>Should a separate spatial random field be estimated?
If enabled then there will be separate spatial and spatiotemporal
fields.</p></td>
    </tr>
    <tr>
      <th>spatial_trend</th>
      <td><p>Should a separate spatial field be included in the
trend that represents local (time) trends? Requires spatiotemporal data.
See <a href='http://dx.doi.org/10.1111/ecog.05176'>http://dx.doi.org/10.1111/ecog.05176</a> and the
<a href='https://pbs-assess.github.io/sdmTMB/articles/spatial-trend-models.html'>spatial trends vignette</a>.</p></td>
    </tr>
    <tr>
      <th>spatial_only</th>
      <td><p>Logical: should only a spatial model be fit (i.e. do not
include spatiotemporal random effects)? By default a spatial-only model
will be fit if there is only one unique value in the time column or the
<code>time</code> argument is left at its default value of <code>NULL</code>.</p></td>
    </tr>
    <tr>
      <th>nlminb_loops</th>
      <td><p>How many times to run <code><a href='https://rdrr.io/r/stats/nlminb.html'>stats::nlminb()</a></code> optimization.
Sometimes restarting the optimizer at the previous best values aids
convergence. If the maximum gradient is still too large,
try increasing this to <code>2</code>.</p></td>
    </tr>
    <tr>
      <th>newton_steps</th>
      <td><p>How many Newton optimization steps to try with
<code><a href='https://rdrr.io/r/stats/optim.html'>stats::optimHess()</a></code> after running <code><a href='https://rdrr.io/r/stats/nlminb.html'>stats::nlminb()</a></code>. Sometimes aids
convergence.</p></td>
    </tr>
    <tr>
      <th>mgcv</th>
      <td><p>Parse the formula with <code><a href='https://rdrr.io/pkg/mgcv/man/gam.html'>mgcv::gam()</a></code>?</p></td>
    </tr>
    <tr>
      <th>previous_fit</th>
      <td><p>A previously fitted sdmTMB model to initialize the
optimization with. Can greatly speed up fitting. Note that the data and
model must be set up <em>exactly</em> the same way! However, the <code>weights</code> argument
can change, which can be useful for cross-validation.</p></td>
    </tr>
    <tr>
      <th>quadratic_roots</th>
      <td><p>Experimental feature for internal use right now; may
be moved to a branch. Logical: should quadratic roots be calculated? Note:
on the sdmTMB side, the first two coefficients are used to generate the
quadratic parameters. This means that if you want to generate a quadratic
profile for depth, and depth and depth^2 are part of your formula, you need
to make sure these are listed first and that an intercept isn't included.
For example, <code>formula = cpue ~ 0 + depth + depth2 + as.factor(year)</code>.</p></td>
    </tr>
    <tr>
      <th>epsilon_predictor</th>
      <td><p>A column name (as character) of a predictor of a
linear trend (in log space) of the spatiotemporal standard deviation. By
default, this is <code>NULL</code> and fits a model with a constant spatiotemporal
variance. However, this argument can also be a character name in the
original data frame (a covariate that ideally has been standardized to have
mean 0 and standard deviation = 1). Because the spatiotemporal field varies
by time step, the standardization should be done by time. If the name of a
predictor is included, a log-linear model is fit where the predictor is
used to model effects on the standard deviation,
e.g. <code>log(sd(i)) = B0 + B1 * epsilon_predictor(i)</code>.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p><strong>Model description</strong></p>
<p>For now, see the
<a href='https://pbs-assess.github.io/sdmTMB/articles/model-description.html'>model description</a>
vignette for a start. There are also descriptions of particular models in
Anderson et al. (2019) and Barnett et al. (2020) (see reference list below).</p>
<p><strong>Offsets</strong></p>
<p>In the model formula, an offset can be included by including <code>+ offset</code> in
the model formula (a reserved word). The offset will be included in any
prediction. <code>offset</code> must be a column in <code>data</code>.</p>
<p><strong>Binomial families</strong>
Following the structure of <code><a href='https://rdrr.io/r/stats/glm.html'>stats::glm()</a></code> and <span class="pkg">glmmTMB</span>, a binomial
family can be specified in one of 4 ways: (1) the response may be a factor
(and the model classifies the first level versus all others), (2) the
response may be binomial (0/1), (3) the response can be a matrix of form
<code><a href='https://rdrr.io/r/base/cbind.html'>cbind(success, failure)</a></code>, and (4) the response may be the observed
proportions, and the 'weights' argument is used to specify the Binomial size
(N) parameter (<code>prob ~ ..., weights = N</code>).</p>
<p><strong>Threshold models</strong></p>
<p>A linear break-point relationship for a covariate can be included via <code>+ breakpt(variable)</code> in the formula, where <code>variable</code> is a single covariate
corresponding to a column in <code>data</code>. In this case the relationship is linear
up to a point and then constant.</p>
<p>Similarly, a logistic-function threshold model can be included via <code>+ logistic(variable)</code>. This option models the relationship as a logistic
function of the 50% and 95% values. This is similar to length- or size-based
selectivity in fisheries, and is parameterized by the points at which f(x) =
0.5 or 0.95. See the vignette.</p>
<p>Note that only a single threshold covariate can be included.</p>
<p>See the
<a href='https://pbs-assess.github.io/sdmTMB/articles/threshold-models.html'>threshold vignette</a>.</p>
<p><strong>Forecasting or interpolating</strong></p>
<p>Extra time slices (e.g., years) can be included for interpolation or
forecasting with the predict function via the <code>extra_time</code> argument. The
predict function requires all time slices to be defined when fitting the
model to ensure the various time indices are set up correctly. Be careful if
including extra time slices that the model remains identifiable. For example,
including <code>+ as.factor(year)</code> in <code>formula</code> will render a model with no data
to inform the expected value in a missing year. <code>sdmTMB()</code> makes no attempt
to determine if the model makes sense for forecasting or interpolation. The
options <code>time_varying</code>, <code>include_spatial</code>, <code>ar1_fields</code>, <code>time = NULL</code>
provide mechanisms to predict over missing time slices.</p>
<p><strong>Index standardization</strong></p>
<p>For index standardization, you may wish to include <code>0 + as.factor(year)</code>
(or whatever the time column is called) in the formula. See a basic
example of index standardization in the relevant
<a href='https://pbs-assess.github.io/sdmTMB/articles/model-description.html'>package vignette</a>.</p>
<p><strong>Regularization</strong></p>
<p>You can achieve regularization via penalties (priors) on the fixed effect
parameters. The vector of values supplied to the <code>penalties</code> argument
represents standard deviations of normal distributions centered on zero with
one value per fixed effect. These can be used for regularization, e.g.,
Normal(0, 1) for ridge regression. These should not include <code>offset</code> terms and
care should be taken if used with splines. You can fit the model once without
penalties and inspect the element <code><a href='https://rdrr.io/r/utils/head.html'>head(your_model$tmb_data$X_ij)</a></code> if you
want to see how the formula is translated to the fixed effect model matrix.
The <code>penalties</code> vector should correspond to the columns of the <code>X_ij</code> matrix.
An element can contain <code>NA</code> if you wish to avoid a penalty/prior on a specific
term (e.g., the intercept).</p>
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Main reference/report introducing the package. We plan to write a paper
to cite in the near future:</p>
<p>Anderson, S.C., E.A. Keppel, A.M. Edwards, 2019. A reproducible data synopsis
for over 100 species of British Columbia groundfish. DFO Can. Sci. Advis. Sec.
Res. Doc. 2019/041. vii + 321 p.
<a href='https://www.dfo-mpo.gc.ca/csas-sccs/Publications/ResDocs-DocRech/2019/2019_041-eng.html'>https://www.dfo-mpo.gc.ca/csas-sccs/Publications/ResDocs-DocRech/2019/2019_041-eng.html</a></p>
<p>Reference for local trends:</p>
<p>Barnett, L.A.K., E.J. Ward, S.C. Anderson. Improving estimates of species
distribution change by incorporating local trends. In press at Ecography.
<a href='https://doi.org/10.1111/ecog.05176'>https://doi.org/10.1111/ecog.05176</a></p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='va'>d</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/subset.html'>subset</a></span><span class='op'>(</span><span class='va'>pcod</span>, <span class='va'>year</span> <span class='op'>&gt;=</span> <span class='fl'>2011</span><span class='op'>)</span> <span class='co'># subset for example speed</span>
<span class='va'>pcod_spde</span> <span class='op'>&lt;-</span> <span class='fu'><a href='make_mesh.html'>make_mesh</a></span><span class='op'>(</span><span class='va'>d</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"X"</span>, <span class='st'>"Y"</span><span class='op'>)</span>, cutoff <span class='op'>=</span> <span class='fl'>30</span><span class='op'>)</span> <span class='co'># a coarse mesh for example speed</span>
<span class='fu'><a href='https://r-spatial.github.io/sf/reference/plot.html'>plot</a></span><span class='op'>(</span><span class='va'>pcod_spde</span><span class='op'>)</span>
</div><div class='img'><img src='sdmTMB-1.png' alt='' width='700' height='433' /></div><div class='input'>
<span class='co'># Tweedie:</span>
<span class='va'>m</span> <span class='op'>&lt;-</span> <span class='fu'>sdmTMB</span><span class='op'>(</span><span class='va'>density</span> <span class='op'>~</span> <span class='fl'>0</span> <span class='op'>+</span> <span class='va'>depth_scaled</span> <span class='op'>+</span> <span class='va'>depth_scaled2</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span>,
  data <span class='op'>=</span> <span class='va'>d</span>, time <span class='op'>=</span> <span class='st'>"year"</span>, spde <span class='op'>=</span> <span class='va'>pcod_spde</span>, family <span class='op'>=</span> <span class='fu'><a href='Families.html'>tweedie</a></span><span class='op'>(</span>link <span class='op'>=</span> <span class='st'>"log"</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Spatial model fit by ML ['sdmTMB']
#&gt; Formula: density ~ 0 + depth_scaled + depth_scaled2 + as.factor(year)
#&gt; Time column: "year"
#&gt; SPDE: pcod_spde
#&gt; Data: d
#&gt; Family: tweedie(link = 'log')
#&gt;                     coef.est coef.se
#&gt; depth_scaled           -1.58    0.20
#&gt; depth_scaled2          -1.11    0.10
#&gt; as.factor(year)2011     3.67    0.34
#&gt; as.factor(year)2013     3.87    0.34
#&gt; as.factor(year)2015     3.78    0.34
#&gt; as.factor(year)2017     3.05    0.35
#&gt; 
#&gt; Matern range parameter: 14.29
#&gt; Dispersion parameter: 14.16
#&gt; Spatial SD (sigma_O): 2.65
#&gt; Spatiotemporal SD (sigma_E): 1.84
#&gt; ML criterion at convergence: 2955.205
#&gt; 
#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</div><div class='input'><span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>m</span>, conf.int <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
</div><div class='output co'>#&gt;                  term  estimate  std.error  conf.low  conf.high
#&gt; 1        depth_scaled -1.576331 0.19996474 -1.968255 -1.1844072
#&gt; 2       depth_scaled2 -1.108996 0.09901702 -1.303066 -0.9149261
#&gt; 3 as.factor(year)2011  3.671941 0.34094673  3.003698  4.3401846
#&gt; 4 as.factor(year)2013  3.873055 0.33816650  3.210261  4.5358491
#&gt; 5 as.factor(year)2015  3.781370 0.33823528  3.118441  4.4442988
#&gt; 6 as.factor(year)2017  3.051183 0.35024411  2.364717  3.7376490</div><div class='input'><span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>m</span>, effects <span class='op'>=</span> <span class='st'>"ran_par"</span>, conf.int <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
</div><div class='output co'>#&gt;      term  estimate std.error   conf.low conf.high
#&gt; 1   range 14.286488        NA  0.7975133 255.92517
#&gt; 2     phi 14.155975        NA 12.8628002  15.57916
#&gt; 3 sigma_O  2.649743        NA  0.1916715  36.63110
#&gt; 4 sigma_E  1.835337        NA  0.1470807  22.90212</div><div class='input'>
<span class='co'># Run extra optimization steps to help convergence:</span>
<span class='va'>m1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='run_extra_optimization.html'>run_extra_optimization</a></span><span class='op'>(</span><span class='va'>m</span>, nlminb_loops <span class='op'>=</span> <span class='fl'>0</span>, newton_steps <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>$</span><span class='va'>gradients</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] 7.412425e-05</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>m1</span><span class='op'>$</span><span class='va'>gradients</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] 7.401035e-09</div><div class='input'>
<span class='co'># Bernoulli:</span>
<span class='va'>pcod_binom</span> <span class='op'>&lt;-</span> <span class='va'>d</span>
<span class='va'>pcod_binom</span><span class='op'>$</span><span class='va'>present</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>pcod_binom</span><span class='op'>$</span><span class='va'>density</span> <span class='op'>&gt;</span> <span class='fl'>0</span>, <span class='fl'>1L</span>, <span class='fl'>0L</span><span class='op'>)</span>
<span class='va'>m_bin</span> <span class='op'>&lt;-</span> <span class='fu'>sdmTMB</span><span class='op'>(</span><span class='va'>present</span> <span class='op'>~</span> <span class='fl'>0</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>depth_scaled</span> <span class='op'>+</span> <span class='va'>depth_scaled2</span>,
  data <span class='op'>=</span> <span class='va'>pcod_binom</span>, time <span class='op'>=</span> <span class='st'>"year"</span>, spde <span class='op'>=</span> <span class='va'>pcod_spde</span>,
  family <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/family.html'>binomial</a></span><span class='op'>(</span>link <span class='op'>=</span> <span class='st'>"logit"</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>m_bin</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Spatial model fit by ML ['sdmTMB']
#&gt; Formula: present ~ 0 + as.factor(year) + depth_scaled + depth_scaled2
#&gt; Time column: "year"
#&gt; SPDE: pcod_spde
#&gt; Data: pcod_binom
#&gt; Family: binomial(link = 'logit')
#&gt;                     coef.est coef.se
#&gt; as.factor(year)2011     0.33    0.47
#&gt; as.factor(year)2013     1.49    0.48
#&gt; as.factor(year)2015     1.16    0.47
#&gt; as.factor(year)2017     0.27    0.47
#&gt; depth_scaled           -2.15    0.28
#&gt; depth_scaled2          -1.63    0.17
#&gt; 
#&gt; Matern range parameter: 27.46
#&gt; Spatial SD (sigma_O): 2.51
#&gt; Spatiotemporal SD (sigma_E): 0.22
#&gt; ML criterion at convergence: 470.433
#&gt; 
#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</div><div class='input'>
<span class='co'># Gaussian:</span>
<span class='va'>pcod_gaus</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/subset.html'>subset</a></span><span class='op'>(</span><span class='va'>d</span>, <span class='va'>density</span> <span class='op'>&gt;</span> <span class='fl'>0</span> <span class='op'>&amp;</span> <span class='va'>year</span> <span class='op'>&gt;=</span> <span class='fl'>2013</span><span class='op'>)</span>
<span class='va'>pcod_spde_gaus</span> <span class='op'>&lt;-</span> <span class='fu'><a href='make_mesh.html'>make_mesh</a></span><span class='op'>(</span><span class='va'>pcod_gaus</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"X"</span>, <span class='st'>"Y"</span><span class='op'>)</span>, cutoff <span class='op'>=</span> <span class='fl'>30</span><span class='op'>)</span>
<span class='va'>m_pos</span> <span class='op'>&lt;-</span> <span class='fu'>sdmTMB</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>density</span><span class='op'>)</span> <span class='op'>~</span> <span class='fl'>0</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>depth_scaled</span> <span class='op'>+</span> <span class='va'>depth_scaled2</span>,
  data <span class='op'>=</span> <span class='va'>pcod_gaus</span>, time <span class='op'>=</span> <span class='st'>"year"</span>, spde <span class='op'>=</span> <span class='va'>pcod_spde_gaus</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>m_pos</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Spatial model fit by ML ['sdmTMB']
#&gt; Formula: log(density) ~ 0 + as.factor(year) + depth_scaled + depth_scaled2
#&gt; Time column: "year"
#&gt; SPDE: pcod_spde_gaus
#&gt; Data: pcod_gaus
#&gt; Family: gaussian(link = 'identity')
#&gt;                     coef.est coef.se
#&gt; as.factor(year)2013     3.63    0.12
#&gt; as.factor(year)2015     3.68    0.13
#&gt; as.factor(year)2017     3.36    0.15
#&gt; depth_scaled           -0.21    0.14
#&gt; depth_scaled2          -0.39    0.10
#&gt; 
#&gt; Matern range parameter: 0.22
#&gt; Dispersion parameter: 1.35
#&gt; Spatial SD (sigma_O): 0.01
#&gt; Spatiotemporal SD (sigma_E): 0.01
#&gt; ML criterion at convergence: 599.014
#&gt; 
#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</div><div class='input'>
<span class='co'># With splines via mgcv.</span>
<span class='co'># Make sure to pre-specify an appropriate basis dimension (`k`) since</span>
<span class='co'># the smoothers are not penalized in the current implementation.</span>
<span class='co'># See ?mgcv::choose.k</span>
<span class='va'>m_gam</span> <span class='op'>&lt;-</span> <span class='fu'>sdmTMB</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>density</span><span class='op'>)</span> <span class='op'>~</span> <span class='fl'>0</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'>s</span><span class='op'>(</span><span class='va'>depth_scaled</span>, k <span class='op'>=</span> <span class='fl'>4</span><span class='op'>)</span>,
  data <span class='op'>=</span> <span class='va'>pcod_gaus</span>, time <span class='op'>=</span> <span class='st'>"year"</span>, spde <span class='op'>=</span> <span class='va'>pcod_spde_gaus</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>m_gam</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Spatial model fit by ML ['sdmTMB']
#&gt; Formula: log(density) ~ 0 + as.factor(year) + s(depth_scaled, k = 4)
#&gt; Time column: "year"
#&gt; SPDE: pcod_spde_gaus
#&gt; Data: pcod_gaus
#&gt; Family: gaussian(link = 'identity')
#&gt;                     coef.est coef.se
#&gt; as.factor(year)2013     3.45    0.11
#&gt; as.factor(year)2015     3.60    0.12
#&gt; as.factor(year)2017     3.23    0.14
#&gt; s(depth_scaled).1       1.04    0.26
#&gt; s(depth_scaled).2      -0.61    0.61
#&gt; s(depth_scaled).3      -0.90    0.30
#&gt; 
#&gt; Matern range parameter: 0.21
#&gt; Dispersion parameter: 1.32
#&gt; Spatial SD (sigma_O): 0.01
#&gt; Spatiotemporal SD (sigma_E): 0.01
#&gt; ML criterion at convergence: 589.528
#&gt; 
#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</div><div class='input'>
<span class='co'># With IID random intercepts:</span>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>
<span class='va'>x</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>500</span>, <span class='op'>-</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>)</span>
<span class='va'>y</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>500</span>, <span class='op'>-</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>)</span>
<span class='va'>loc</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span><span class='op'>)</span>
<span class='va'>spde</span> <span class='op'>&lt;-</span> <span class='fu'><a href='make_mesh.html'>make_mesh</a></span><span class='op'>(</span><span class='va'>loc</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"x"</span>, <span class='st'>"y"</span><span class='op'>)</span>, n_knots <span class='op'>=</span> <span class='fl'>50</span>, type <span class='op'>=</span> <span class='st'>"kmeans"</span><span class='op'>)</span>
<span class='va'>s</span> <span class='op'>&lt;-</span> <span class='fu'><a href='sdmTMB_sim.html'>sdmTMB_sim</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span>, betas <span class='op'>=</span> <span class='fl'>0</span>, time <span class='op'>=</span> <span class='fl'>1L</span>,
  phi <span class='op'>=</span> <span class='fl'>0.1</span>, range <span class='op'>=</span> <span class='fl'>1.4</span>, sigma_O <span class='op'>=</span> <span class='fl'>0.2</span>, sigma_E <span class='op'>=</span> <span class='fl'>0</span>, mesh <span class='op'>=</span> <span class='va'>spde</span><span class='op'>)</span>
<span class='va'>s</span><span class='op'>$</span><span class='va'>g</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/gl.html'>gl</a></span><span class='op'>(</span><span class='fl'>50</span>, <span class='fl'>10</span><span class='op'>)</span>
<span class='va'>iid_re_vals</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fl'>50</span>, <span class='fl'>0</span>, <span class='fl'>0.3</span><span class='op'>)</span>
<span class='va'>s</span><span class='op'>$</span><span class='va'>observed</span> <span class='op'>&lt;-</span> <span class='va'>s</span><span class='op'>$</span><span class='va'>observed</span> <span class='op'>+</span> <span class='va'>iid_re_vals</span><span class='op'>[</span><span class='va'>s</span><span class='op'>$</span><span class='va'>g</span><span class='op'>]</span>
<span class='va'>m</span> <span class='op'>&lt;-</span> <span class='fu'>sdmTMB</span><span class='op'>(</span><span class='va'>observed</span> <span class='op'>~</span> <span class='fl'>1</span> <span class='op'>+</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>g</span><span class='op'>)</span>, spde <span class='op'>=</span> <span class='va'>spde</span>, data <span class='op'>=</span> <span class='va'>s</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Spatial model fit by ML ['sdmTMB']
#&gt; Formula: observed ~ 1 + (1 | g)
#&gt; Time column: NULL
#&gt; SPDE: spde
#&gt; Data: s
#&gt; Family: gaussian(link = 'identity')
#&gt;             coef.est coef.se
#&gt; (Intercept)     0.16    0.38
#&gt; 
#&gt;               Std. Dev.
#&gt; g (Intercept)      0.28
#&gt; 
#&gt; Matern range parameter: 2.39
#&gt; Dispersion parameter: 0.10
#&gt; Spatial SD (sigma_O): 0.29
#&gt; Spatiotemporal SD (sigma_E): not estimated
#&gt; ML criterion at convergence: -273.194
#&gt; 
#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</div><div class='input'><span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>m</span>, <span class='st'>"ran_pars"</span>, conf.int <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='co'># see tau_G</span>
</div><div class='output co'>#&gt;      term  estimate std.error   conf.low conf.high
#&gt; 1   range 2.3892920        NA 1.11612804 5.1147504
#&gt; 2     phi 0.1005214        NA 0.09371961 0.1078168
#&gt; 3 sigma_O 0.2883875        NA 0.15444212 0.5385018
#&gt; 5   tau_G 0.2819940        NA 0.23071648 0.3446682</div><div class='input'><span class='va'>theta</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>as.list</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>$</span><span class='va'>sd_report</span>, <span class='st'>"Estimate"</span><span class='op'>)</span>
<span class='fu'><a href='https://r-spatial.github.io/sf/reference/plot.html'>plot</a></span><span class='op'>(</span><span class='va'>iid_re_vals</span>, <span class='va'>theta</span><span class='op'>$</span><span class='va'>RE</span><span class='op'>)</span>
</div><div class='img'><img src='sdmTMB-2.png' alt='' width='700' height='433' /></div><div class='input'>
<span class='co'># \donttest{</span>
<span class='co'># Fit a spatial only model:</span>
<span class='va'>m</span> <span class='op'>&lt;-</span> <span class='fu'>sdmTMB</span><span class='op'>(</span>
  <span class='va'>density</span> <span class='op'>~</span> <span class='va'>depth_scaled</span> <span class='op'>+</span> <span class='va'>depth_scaled2</span>, data <span class='op'>=</span> <span class='va'>d</span>,
  spde <span class='op'>=</span> <span class='va'>pcod_spde</span>, family <span class='op'>=</span> <span class='fu'><a href='Families.html'>tweedie</a></span><span class='op'>(</span>link <span class='op'>=</span> <span class='st'>"log"</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Spatial model fit by ML ['sdmTMB']
#&gt; Formula: density ~ depth_scaled + depth_scaled2
#&gt; Time column: NULL
#&gt; SPDE: pcod_spde
#&gt; Data: d
#&gt; Family: tweedie(link = 'log')
#&gt;               coef.est coef.se
#&gt; (Intercept)       3.67    0.30
#&gt; depth_scaled     -1.49    0.19
#&gt; depth_scaled2    -1.00    0.09
#&gt; 
#&gt; Matern range parameter: 0.03
#&gt; Dispersion parameter: 14.78
#&gt; Spatial SD (sigma_O): 1676.96
#&gt; Spatiotemporal SD (sigma_E): not estimated
#&gt; ML criterion at convergence: 2974.181
#&gt; 
#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</div><div class='input'>
<span class='co'># Spatial-trend example:</span>
<span class='va'>m</span> <span class='op'>&lt;-</span> <span class='fu'>sdmTMB</span><span class='op'>(</span><span class='va'>density</span> <span class='op'>~</span> <span class='va'>depth_scaled</span>, data <span class='op'>=</span> <span class='va'>d</span>,
  spde <span class='op'>=</span> <span class='va'>pcod_spde</span>, family <span class='op'>=</span> <span class='fu'><a href='Families.html'>tweedie</a></span><span class='op'>(</span>link <span class='op'>=</span> <span class='st'>"log"</span><span class='op'>)</span>,
  spatial_trend <span class='op'>=</span> <span class='cn'>TRUE</span>, time <span class='op'>=</span> <span class='st'>"year"</span><span class='op'>)</span>
<span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>m</span>, effects <span class='op'>=</span> <span class='st'>"ran_par"</span><span class='op'>)</span>
</div><div class='output co'>#&gt;       term   estimate std.error
#&gt; 1    range 24.7819978        NA
#&gt; 2      phi 15.5051233        NA
#&gt; 3  sigma_O  2.5786216        NA
#&gt; 4  sigma_E  0.8739983        NA
#&gt; 5  sigma_Z  0.3300048        NA
#&gt; 6 ln_tau_V  0.0000000        NA</div><div class='input'>
<span class='co'># Time-varying effects of depth and depth squared:</span>
<span class='va'>m</span> <span class='op'>&lt;-</span> <span class='fu'>sdmTMB</span><span class='op'>(</span><span class='va'>density</span> <span class='op'>~</span> <span class='fl'>0</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span>,
  time_varying <span class='op'>=</span> <span class='op'>~</span> <span class='fl'>0</span> <span class='op'>+</span> <span class='va'>depth_scaled</span> <span class='op'>+</span> <span class='va'>depth_scaled2</span>,
  data <span class='op'>=</span> <span class='va'>d</span>, time <span class='op'>=</span> <span class='st'>"year"</span>, spde <span class='op'>=</span> <span class='va'>pcod_spde</span>, family <span class='op'>=</span> <span class='fu'><a href='Families.html'>tweedie</a></span><span class='op'>(</span>link <span class='op'>=</span> <span class='st'>"log"</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Spatial model fit by ML ['sdmTMB']
#&gt; Formula: density ~ 0 + as.factor(year)
#&gt; Time column: "year"
#&gt; SPDE: pcod_spde
#&gt; Data: d
#&gt; Family: tweedie(link = 'log')
#&gt;                     coef.est coef.se
#&gt; as.factor(year)2011     4.01    0.32
#&gt; as.factor(year)2013     3.68    0.30
#&gt; as.factor(year)2015     4.03    0.31
#&gt; as.factor(year)2017     3.42    0.34
#&gt; 
#&gt; Time-varying parameters:
#&gt;                    coef.est coef.se
#&gt; depth_scaled-2011     -0.78    0.14
#&gt; depth_scaled-2013     -0.75    0.13
#&gt; depth_scaled-2015     -0.73    0.14
#&gt; depth_scaled-2017     -1.02    0.24
#&gt; depth_scaled2-2011    -1.76    0.25
#&gt; depth_scaled2-2013    -0.79    0.13
#&gt; depth_scaled2-2015    -1.53    0.21
#&gt; depth_scaled2-2017    -2.07    0.34
#&gt; 
#&gt; Matern range parameter: 6.23
#&gt; Dispersion parameter: 13.78
#&gt; Spatial SD (sigma_O): 5.23
#&gt; Spatiotemporal SD (sigma_E): 3.65
#&gt; ML criterion at convergence: 2943.572
#&gt; 
#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</div><div class='input'>
<span class='co'># See the b_rw_t estimates; these are the time-varying (random walk) effects.</span>
<span class='co'># These could be added to tidy.sdmTMB() eventually.</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>$</span><span class='va'>sd_report</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>19</span>,<span class='op'>]</span>
</div><div class='output co'>#&gt;            Estimate  Std. Error
#&gt; b_j       4.0090869  0.31751958
#&gt; b_j       3.6751809  0.30409946
#&gt; b_j       4.0278775  0.31422337
#&gt; b_j       3.4204686  0.33726404
#&gt; ln_tau_O -2.1297489 13.60894756
#&gt; ln_tau_E -1.7704156 13.59333829
#&gt; ln_kappa -0.7894433  6.89102319
#&gt; thetaf    0.3172205  0.06427312
#&gt; ln_phi    2.6232965  0.04895034
#&gt; ln_tau_V -1.5247834  0.84952350
#&gt; ln_tau_V -0.2008950  0.45430294
#&gt; b_rw_t   -0.7777383  0.14304716
#&gt; b_rw_t   -0.7505321  0.12626465
#&gt; b_rw_t   -0.7338111  0.13539466
#&gt; b_rw_t   -1.0153735  0.23736182
#&gt; b_rw_t   -1.7649952  0.25180629
#&gt; b_rw_t   -0.7903728  0.12822862
#&gt; b_rw_t   -1.5261893  0.21146328
#&gt; b_rw_t   -2.0694461  0.34416970</div><div class='input'>
<span class='co'># Linear breakpoint model on depth:</span>
<span class='va'>m_pos</span> <span class='op'>&lt;-</span> <span class='fu'>sdmTMB</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>density</span><span class='op'>)</span> <span class='op'>~</span> <span class='fl'>0</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>breakpt</span><span class='op'>(</span><span class='va'>depth_scaled</span><span class='op'>)</span> <span class='op'>+</span> <span class='va'>depth_scaled2</span>, data <span class='op'>=</span> <span class='va'>pcod_gaus</span>,
  time <span class='op'>=</span> <span class='st'>"year"</span>, spde <span class='op'>=</span> <span class='va'>pcod_spde_gaus</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='warning'>Warning: The model may not have converged: non-positive-definite Hessian matrix.</span></div><div class='input'><span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>m_pos</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Spatial model fit by ML ['sdmTMB']
#&gt; Formula: log(density) ~ 0 + as.factor(year) + breakpt(depth_scaled) + 
#&gt; Formula:     depth_scaled2
#&gt; Time column: "year"
#&gt; SPDE: pcod_spde_gaus
#&gt; Data: pcod_gaus
#&gt; Family: gaussian(link = 'identity')
#&gt;                      coef.est coef.se
#&gt; as.factor(year)2013      4.24     NaN
#&gt; as.factor(year)2015      4.30     NaN
#&gt; as.factor(year)2017      4.03     NaN
#&gt; depth_scaled2            0.21     NaN
#&gt; depth_scaled-slope       1.35     NaN
#&gt; depth_scaled-breakpt    -0.72     NaN
#&gt; 
#&gt; Matern range parameter: 0.21
#&gt; Dispersion parameter: 1.33
#&gt; Spatial SD (sigma_O): 0.01
#&gt; Spatiotemporal SD (sigma_E): 0.01
#&gt; ML criterion at convergence: 592.503
#&gt; 
#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</div><div class='input'>
<span class='co'># Linear covariate on log(sigma_epsilon):</span>
<span class='co'># First we will center the years around their mean</span>
<span class='co'># to help with convergence.</span>
<span class='va'>d</span><span class='op'>$</span><span class='va'>year_centered</span> <span class='op'>&lt;-</span> <span class='va'>d</span><span class='op'>$</span><span class='va'>year</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>$</span><span class='va'>year</span><span class='op'>)</span>
<span class='va'>m</span> <span class='op'>&lt;-</span> <span class='fu'>sdmTMB</span><span class='op'>(</span><span class='va'>density</span> <span class='op'>~</span> <span class='fl'>0</span> <span class='op'>+</span> <span class='va'>depth_scaled</span> <span class='op'>+</span> <span class='va'>depth_scaled2</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span>,
  data <span class='op'>=</span> <span class='va'>d</span>, time <span class='op'>=</span> <span class='st'>"year"</span>, spde <span class='op'>=</span> <span class='va'>pcod_spde</span>, family <span class='op'>=</span> <span class='fu'><a href='Families.html'>tweedie</a></span><span class='op'>(</span>link <span class='op'>=</span> <span class='st'>"log"</span><span class='op'>)</span>,
  epsilon_predictor <span class='op'>=</span> <span class='st'>"year_centered"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>)</span> <span class='co'># sigma_E varies with time now</span>
</div><div class='output co'>#&gt; Spatial model fit by ML ['sdmTMB']
#&gt; Formula: density ~ 0 + depth_scaled + depth_scaled2 + as.factor(year)
#&gt; Time column: "year"
#&gt; SPDE: pcod_spde
#&gt; Data: d
#&gt; Family: tweedie(link = 'log')
#&gt;                     coef.est coef.se
#&gt; depth_scaled           -1.58    0.20
#&gt; depth_scaled2          -1.11    0.10
#&gt; as.factor(year)2011     3.66    0.36
#&gt; as.factor(year)2013     3.87    0.34
#&gt; as.factor(year)2015     3.78    0.34
#&gt; as.factor(year)2017     3.06    0.35
#&gt; 
#&gt; Matern range parameter: 14.75
#&gt; Dispersion parameter: 14.15
#&gt; Spatial SD (sigma_O): 2.60
#&gt; Spatiotemporal SD (sigma_E): 1.93
#&gt; Spatiotemporal SD (sigma_E): 1.82
#&gt; Spatiotemporal SD (sigma_E): 1.71
#&gt; Spatiotemporal SD (sigma_E): 1.61
#&gt; ML criterion at convergence: 2955.172
#&gt; 
#&gt; See ?tidy.sdmTMB to extract these values as a data frame.</div><div class='input'><span class='co'># coefficient is not yet in tidy.sdmTMB:</span>
<span class='fu'><a href='https://rdrr.io/r/base/list.html'>as.list</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>$</span><span class='va'>sd_report</span>, <span class='st'>"Estimate"</span>, report <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>$</span><span class='va'>b_epsilon</span>
</div><div class='output co'>#&gt; [1] -0.02969456</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/base/list.html'>as.list</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>$</span><span class='va'>sd_report</span>, <span class='st'>"Std. Error"</span>, report <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>$</span><span class='va'>b_epsilon</span>
</div><div class='output co'>#&gt; [1] 0.1175937</div><div class='input'><span class='co'># }</span>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Sean C. Anderson, Eric J. Ward, Lewis A. K. Barnett, Philina A. English.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


